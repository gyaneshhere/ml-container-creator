#!/bin/bash
# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0

echo "Starting <%= modelServer === 'vllm' ? 'vLLM' : 'SGLang' %> server"

# Initialize server arguments
# port 8080 required by SageMaker: https://docs.aws.amazon.com/sagemaker/latest/dg/your-algorithms-inference-code.html#your-algorithms-inference-code-container-response
SERVER_ARGS=(--host 0.0.0.0 --port 8080)

# Define the prefix for environment variables to look for
PREFIX="<%= modelServer === 'vllm' ? 'VLLM_' : 'SGLANG_' %>"
ARG_PREFIX="--"

# Define environment variables to exclude (internal variables set by base images)
<% if (modelServer === 'vllm') { %>
EXCLUDE_VARS=("VLLM_USAGE_SOURCE")
<% } else { %>
EXCLUDE_VARS=()
<% } %>

# Declare and populate array of matching environment variables
mapfile -t env_vars < <(env | grep "^${PREFIX}")

# Loop through the array and convert to command-line arguments
for var in "${env_vars[@]}"; do
    IFS='=' read -r key value <<< "$var"
    
    # Skip excluded variables
    skip=false
    for exclude in "${EXCLUDE_VARS[@]}"; do
        if [ "$key" = "$exclude" ]; then
            skip=true
            break
        fi
    done
    
    if [ "$skip" = true ]; then
        continue
    fi
    
    # Remove prefix, convert to lowercase, and replace underscores with dashes
    arg_name=$(echo "${key#"${PREFIX}"}" | tr '[:upper:]' '[:lower:]' | tr '_' '-')
    SERVER_ARGS+=("${ARG_PREFIX}${arg_name}")
    if [ -n "$value" ]; then
        SERVER_ARGS+=("$value")
    fi
done

echo "-------------------------------------------------------------------"
echo "<%= modelServer === 'vllm' ? 'vLLM' : 'SGLang' %> engine args: [${SERVER_ARGS[@]}]"
echo "-------------------------------------------------------------------"

# Pass the collected arguments to the main entrypoint
<% if (modelServer === 'vllm') { %>
exec python3 -m vllm.entrypoints.openai.api_server "${SERVER_ARGS[@]}"
<% } else { %>
exec python3 -m sglang.launch_server "${SERVER_ARGS[@]}"
<% } %>